version: 2

jobs:
  installation:
    working_directory: ~/pkijs
    docker:
      - image: "circleci/node:8.7.0"
    environment:
      COVERALLS_REPO_TOKEN: 5VZxtP3jvfuAygXWjgkaJCrHpT9FwiVTU
    steps:
      - run:
          name: Installing global dependencies
          command: sudo npm install -g typescript rollup nyc coveralls
      - checkout
      - attach_workspace:
          at: ~/pkijs
      - run:
          name: Installing PKI.js
          command: npm install
      - save_cache:
          key: -{{ .Branch }}-{{ .BuildNum }}
          paths:
            - ~/pkijs
  test1:
    working_directory: ~/pkijs
    docker:
      - image: "circleci/node:8.7.0"
    steps:
      - restore_cache:
          key: -{{ .Branch }}-{{ .BuildNum }}
      - run: ls -al

  test2:
    working_directory: ~/pkijs
    docker:
      - image: "circleci/node:8.7.0"
    steps:
      - checkout
      - attach_workspace:
          at: ~/pkijs
      - restore_cache:
          key: -{{ .Branch }}-{{ .BuildNum }}
      - run: ls -al

workflows:
  version: 2
  main:
    jobs:
      - installation:
          filters:
            branches:
              ignore:
                - gh-pages
      - test1:
          filters:
            branches:
              ignore:
                - gh-pages
          requires:
            - installation
      - test2:
          filters:
            branches:
              ignore:
                - gh-pages
          requires:
            - installation